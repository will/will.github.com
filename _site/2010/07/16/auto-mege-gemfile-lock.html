<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
   <meta http-equiv="content-type" content="text/html; charset=utf-8" />
   <title>Auto Merge Gemfile.lock</title>
   <meta name="author" content="Tom Preston-Werner" />
   <link href="http://feeds.feedburner.com/tom-preston-werner" rel="alternate" title="Tom Preston-Werner" type="application/atom+xml" />

   <!-- syntax highlighting CSS -->
   <link rel="stylesheet" href="/css/syntax.css" type="text/css" />

   <!-- Homepage CSS -->
   <link rel="stylesheet" href="/css/screen.css" type="text/css" media="screen, projection" />

   <!-- Typekit -->
   <script type="text/javascript" src="http://use.typekit.com/jpd0pfm.js"></script>
   <script type="text/javascript">try{Typekit.load();}catch(e){}</script>
</head>
<body>

<!-- ClickTale Top part -->
<script type="text/javascript">
var WRInitTime=(new Date()).getTime();
</script>
<!-- ClickTale end of Top part -->

<div class="site">
  <div class="title">
    <a href="/">Tom Preston-Werner</a>
    <a class="extra" href="/">home</a>
  </div>
  
  <div id="post">
<div class="right image">
  <img src="/images/lock.jpg" />
</div>


<p>Here's the problem: you're working on a topic branch and add a gem to your Gemfile, and someone else has added a gem to master before you're done. When you go to rebase, every single one of your commits is going to have a conflict with <code>Gemfile.lock</code>.</p>

<p>All you have to do is run <code>bundle lock</code> to get bundler to relock then add that and continue your rebase. But that's so damn tedious.</p>

<p>Good news! I just figured out how to tell git how to do that for you, and it works great. There are two files you have to edit.</p>

<h3>gitconfig</h3>

<p>First is your <code>~/.gitconfig</code> file. Here we're going to give it a new merge strategy, one that will just relock the gemfile. Add this to the end:</p>

<pre><code>[merge "gemfilelock"]
  name = relocks the gemfile.lock
  driver = bundle lock
</code></pre>

<p>The driver is what git will use to try and fix the conflict. Its exit status will tell git if the merge was successful or not. Here all we're doing is having bundler relock. You can see it in action in <a href="http://github.com/will/dotfiles/commit/4ed4930c61df795b7fbc9732d3c6463164ebb43f">my dotfiles</a></p>

<h3>gitattributes</h3>

<p>Next up, we have to tell git to use our new strategy for <code>Gemfile.lock</code>, and we do that with <a href="http://www.kernel.org/pub/software/scm/git/docs/gitattributes.html">gitattributes</a>. You can either put this in <code>project/.git/info/attributes</code> or <code>project/.gitattributes</code>. I did the .git directory one myself, but it doesn't matter. We just need one line in this file:</p>

<pre><code>Gemfile.lock merge=gemfilelock
</code></pre>

<h3>results</h3>

<p>And that's it! Here's what happen when you rebase now</p>

<pre><code>First, rewinding head to replay your work on top of it...
Applying: commit one
Using index info to reconstruct a base tree...
Falling back to patching base and 3-way merge...
Your bundle is already locked, relocking.
<span style="color: green;">Your bundle is now locked. Use `bundle show [gemname]` to list the gems in the environment.</span>
Auto-merging Gemfile
Auto-merging Gemfile.lock
</code></pre>


<p>Now that, if I may say so myself, is really awesome! (image credit <a href="http://www.flickr.com/photos/maistora/3237164755/">malstora</a>)</p>

</div>

<div id="related">
  <h2>Related Posts</h2>
  <ul class="posts">
    
      <li><span>10 Oct 2010</span> &raquo; <a href="/2010/10/10/some-talks.html">Some Talks</a></li>
    
      <li><span>01 May 2010</span> &raquo; <a href="/2010/05/01/rails_integration_stack_for_winners.html">Rails Integration Testing Stack for Winners</a></li>
    
      <li><span>22 Apr 2010</span> &raquo; <a href="/2010/04/22/speaking_at_rdrc.html">Red Dirt Ruby Conference</a></li>
    
  </ul>
</div>
  
  <div class="footer">
    <div class="contact">
      <p>
        Tom Preston-Werner<br />
        Cofounder of <a href="http://github.com/">GitHub</a><br />
        tom@mojombo.com
      </p>
    </div>
    <div class="contact">
      <p>
        <a href="http://github.com/mojombo/">github.com/mojombo</a><br />
        <a href="http://twitter.com/mojombo/">twitter.com/mojombo</a><br />
        <a href="http://flickr.com/photos/mojombo/">flickr.com/photos/mojombo</a>
      </p>
    </div>
    <div class="rss">
      <a href="http://feeds.feedburner.com/tom-preston-werner">
        <img src="/images/rss.png" alt="Subscribe to RSS Feed" />
      </a>
    </div>
  </div>
</div>

<a href="http://github.com/mojombo"><img style="position: absolute; top: 0; right: 0; border: 0;" src="http://s3.amazonaws.com/github/ribbons/forkme_right_red_aa0000.png" alt="Fork me on GitHub" /></a>

<!-- ClickTale Bottom part -->
<div id="ClickTaleDiv" style="display: none;"></div>
<script type="text/javascript">
if(document.location.protocol!='https:')
  document.write(unescape("%3Cscript%20src='http://s.clicktale.net/WRb.js'%20type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
if(typeof ClickTale=='function') ClickTale(206,0.3,"www03");
</script>
<!-- ClickTale end of Bottom part -->

<!-- Google Analytics -->
<script type="text/javascript">
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
var pageTracker = _gat._getTracker("UA-6016902-1");
pageTracker._trackPageview();
</script>
<!-- Google Analytics end -->

</body>
</html>
